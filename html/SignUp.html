<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<html>
	<head>
		<link rel="stylesheet" media="screen" href="./css/style.css">
	</head>

	<body>
		<div id="container">
			<div class="basic-grey">
				<form>
					<p>
						<span>登录帐号</span>
						<input type="text" id="account" value="13478671881">
					</p>
					<p>
						<span>登录密码</span>
						<input type="password" id="password" value="111111">
					</p>
					 <p>
						<span>重复密码</span>
						<input type="password" id="confirm" value="111111">
					</p>
					<p>
						<span>所属大区</span>
						<input type="text" id="locality" value="华北">
					</p>
					<p>
						<span>所属地区</span>
						<input type="text" id="region" value="辽宁">
					<p>
						<span>真实姓名</span>
						<input type="text" id="name" value="叶子">
					</p>
				</form>

				<form id = "controls">
					<input type="button" value="注册" onclick="signUp()">
				</form>
			</div>
		</div>
	</body>

	<script type="text/javascript" src="./jquery/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="./js/model.js"></script>
	<script>
		function signUp() {
			var account = document.getElementById("account");
			var password = document.getElementById("password");
			var confirm = document.getElementById("confirm");
			var locality = document.getElementById("locality");
			var region = document.getElementById("region");
			var name = document.getElementById("name");

			if (password.value != confirm.value) {
				alert("密码不一致，请重新输入");
				return;
			}

			var jsonData = {"account":account.value, "password":password.value, "name":name.value, "locality":locality.value, "region":region.value};
			var jsonString = JSON.stringify(jsonData);
			$.ajax({
				'type': 'POST',
				'url': "http://121.42.192.153/user/signUp",
				'contentType': 'application/json',
				'data': jsonString,
				'dataType': 'json',
				'success': function (data, status) {
					if (!data.success) {
						alert(data.msg);
						return;
					}
					var m = model.sharedInstance();
					m.account = account.value;
					m.password = password.value;
					m.name = name.value;
					m.locality = locality.value;
					m.region = region.value;
					m.authority = data.authority;
					m.session = data.session;

					$.ajax({
						'type': 'POST',
						'url': "http://121.42.192.153/topics/query",
						'contentType': 'application/json',
						'data': JSON.stringify({"session":m.session}),
						'dataType': 'json',
						'success': function (data, status) {
							if (!data.success) {
								alert(data.msg);
								return;
							}

							m.topics = new Array();
							$(data.topics).each(function(index, element) {
								m.topics.push({"id":element.topicID, "timestamp":element.timestamp});
							});

							var topics = new Array();
							while(topics.length != 20) {
								var random = Math.floor(Math.random() * (data.topics.length));
								if ($.inArray(m.topics[random].id, topics) == -1) {
									topics.push(m.topics[random].id);
								}
							}

							$.ajax({
								'type': 'POST',
								'url': "http://121.42.192.153/topics/get",
								'contentType': 'application/json',
								'data': JSON.stringify({"session":m.session, topics:topics}),
								'dataType': 'json',
								'success': function (data, status) {
									m.selectedTopics = new Array();
									$(data.topics).each(function(index, element) {
										var topic;
										$(m.topics).each(function(index, elementt) {
											if (elementt.id == element.topicID) {
												topic = elementt;
												return false;
											}
										});
										topic.description = element.description;
										topic.options = element.options;
										topic.correct = element.correct;
										m.selectedTopics.push(topic);
									});
									storage();
									location.href = "SelectType.html";
								}
							});
						}
					});
				}
			});
		}
	</script>
</html>

